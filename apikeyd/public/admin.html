<!-- public/admin.html (revisi) -->
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel — UwUntu Cyber Console</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Poppins',sans-serif;margin:0;padding:18px;background:#fff0f6;color:#333}
    .wrap{max-width:980px;margin:0 auto}
    h1{color:#ff4081}
    .card{background:#fff;border-radius:12px;padding:16px;margin-bottom:12px;box-shadow:0 6px 18px rgba(255,59,141,0.06)}
    input{padding:8px;border-radius:8px;border:1px solid #ffd3e6;margin-right:8px}
    button{padding:8px 12px;border-radius:8px;border:none;background:#ff4c86;color:white;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;border-bottom:1px solid #ffe6f0;text-align:left;font-size:13px}
    .btn-logout{background:#fff;color:#ff4c86;border:1px solid #ffd3e6;padding:6px 10px;border-radius:8px}
    .status-online{color:green;font-weight:600}
    .status-off{color:#999}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Admin — UwUntu Cyber Console</h1>

    <div class="card" id="authCard">
      <div id="authForms">
        <div style="margin-bottom:8px;">
          <strong>Register Admin</strong><br>
          <input id="regEmail" placeholder="email" />
          <input id="regPass" placeholder="password" type="password" />
          <button id="regBtn">Register</button>
        </div>
        <div>
          <strong>Login</strong><br>
          <input id="loginEmail" placeholder="email" />
          <input id="loginPass" placeholder="password" type="password" />
          <button id="loginBtn">Login</button>
        </div>
        <div id="authMsg" style="margin-top:8px;color:#9a2f60"></div>
      </div>

      <div id="adminTools" style="display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Welcome, Admin</strong></div>
          <div>
            <button class="btn-logout" id="logoutBtn">Logout</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <button id="refreshBtn">Refresh list</button>
          <button id="exportBtn">Export CSV</button>
        </div>

        <div id="usersWrapper" style="margin-top:12px"></div>
      </div>
    </div>

  </div>

  <script>
    // admin UI logic
    const regEmail = document.getElementById('regEmail');
    const regPass = document.getElementById('regPass');
    const regBtn = document.getElementById('regBtn');
    const loginEmail = document.getElementById('loginEmail');
    const loginPass = document.getElementById('loginPass');
    const loginBtn = document.getElementById('loginBtn');
    const authMsg = document.getElementById('authMsg');
    const adminTools = document.getElementById('adminTools');
    const authForms = document.getElementById('authForms');
    const logoutBtn = document.getElementById('logoutBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const usersWrapper = document.getElementById('usersWrapper');
    const exportBtn = document.getElementById('exportBtn');

    regBtn.addEventListener('click', async () => {
      const email = regEmail.value.trim(); const password = regPass.value;
      if (!email || !password) { authMsg.textContent = 'Email & password required'; return; }
      try {
        const res = await fetch('/admin/register', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email, password }) });
        const data = await res.json(); if (!res.ok) throw new Error(data.error || 'register error');
        authMsg.style.color='green'; authMsg.textContent='Registered. Please login.';
      } catch (e) { authMsg.style.color='red'; authMsg.textContent = e.message; }
    });

    loginBtn.addEventListener('click', async () => {
      const email = loginEmail.value.trim(); const password = loginPass.value;
      if (!email || !password) { authMsg.textContent = 'Email & password required'; return; }
      try {
        const res = await fetch('/admin/login', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email, password }) });
        const data = await res.json(); if (!res.ok) throw new Error(data.error || 'login error');
        authMsg.style.color='green'; authMsg.textContent='Login successful'; showAdminTools();
      } catch (e) { authMsg.style.color='red'; authMsg.textContent = e.message; }
    });

    logoutBtn.addEventListener('click', async () => { await fetch('/admin/logout', { method: 'POST' }); adminTools.style.display='none'; authForms.style.display='block'; authMsg.style.color='#9a2f60'; authMsg.textContent='Logged out'; });
    refreshBtn.addEventListener('click', loadUsers);
    exportBtn.addEventListener('click', ()=>{ window.location.href = '/admin/api/export'; });

    async function showAdminTools(){ authForms.style.display='none'; adminTools.style.display='block'; await loadUsers(); }

    async function loadUsers(){
      usersWrapper.innerHTML = 'Loading...';
      try{
        const res = await fetch('/admin/api/users');
        if (res.status === 401) { usersWrapper.innerHTML='Unauthorized — please login.'; adminTools.style.display='none'; authForms.style.display='block'; return; }
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Fetch failed');
        if (!data.users || data.users.length === 0) { usersWrapper.innerHTML = '<em>No users yet</em>'; return; }

        const table = document.createElement('table');
        table.innerHTML = `<thead><tr><th>ID</th><th>Name</th><th>Email</th><th>API Key</th><th>Created</th><th>API Created</th><th>Last Seen</th><th>Status</th><th>Actions</th></tr></thead>`;
        const tbody = document.createElement('tbody');

        data.users.forEach(u=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${u.id}</td>
                          <td>${escapeHtml(u.firstname)} ${escapeHtml(u.lastname)}</td>
                          <td>${escapeHtml(u.email)}</td>
                          <td style="font-family:monospace">${u.api_key||'-'}</td>
                          <td>${u.user_created_at||'-'}</td>
                          <td>${u.apikey_created_at||'-'}</td>
                          <td>${u.last_seen_ago || (u.last_seen||'-')}</td>
                          <td>${u.status === 'online' ? '<span class="status-online">online</span>' : '<span class="status-off">offline</span>'}</td>
                          <td><button class="revoke" data-id="${u.id}">Revoke</button></td>`;
          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        usersWrapper.innerHTML='';
        usersWrapper.appendChild(table);

        Array.from(document.querySelectorAll('.revoke')).forEach(btn=>btn.addEventListener('click', async (e)=>{
          const id = e.currentTarget.dataset.id;
          if (!confirm(`Delete user ${id} and ALL their data? This cannot be undone.`)) return;
          const r = await fetch(`/admin/api/user/${id}/revoke`, { method: 'DELETE' });
          if (r.ok) { alert('User deleted'); loadUsers(); } else {
            const err = await r.json().catch(()=>({error:'unknown'}));
            alert('Error: ' + (err.error || 'unknown'));
          }
        }));

      }catch(e){
        usersWrapper.innerHTML = `<div style="color:red">Error: ${e.message}</div>`;
      }
    }

    function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>\"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    (async ()=>{ try{ const res = await fetch('/admin/api/users'); if (res.ok) showAdminTools(); }catch(e){} })();
  </script>
</body>
</html>
